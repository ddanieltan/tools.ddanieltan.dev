<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="art.svg">
    <title>Hawker Centre Cleaning Schedule</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        /* Base Reset & Layout */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fdfdfd;
            color: #333;
            line-height: 1.6;
        }

        /* Header & Icon */
        header {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tool-icon {
            height: 5em;
            background-color: white;
            border: 2px solid #1e293b;
            border-radius: 8px;
            padding: 5px;
        }

        h1 {
            margin: 0;
            font-size: 2.5rem;
            color: #1e293b;
            letter-spacing: -0.5px;
        }

        .subtitle {
            color: #64748b;
            margin: 0;
            font-size: 1rem;
        }

        /* Common UI Components */
        .container {
            background: white;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        button {
            background-color: #333;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #555;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Map */
        #map {
            height: 400px;
            width: 100%;
            margin-bottom: 20px;
            border-radius: 6px;
            border: 1px solid #eee;
            z-index: 1;
            /* Ensure it stays below headers if sticky */
        }

        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            font-size: 12px;
            line-height: 1.5;
        }

        .legend i {
            width: 10px;
            height: 10px;
            float: left;
            margin-right: 8px;
            opacity: 0.8;
            border-radius: 50%;
            margin-top: 4px;
        }

        /* Details Section */
        .details-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 24px;
            margin-top: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .details-header {
            margin-bottom: 16px;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 16px;
        }

        .details-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0 0 4px 0;
        }

        .details-subtitle {
            color: #64748b;
            font-size: 0.95rem;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .detail-item label {
            display: block;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            color: #94a3b8;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .detail-item span {
            font-size: 1.1rem;
            color: #334155;
            font-weight: 500;
        }

        .highlight-red {
            color: #ef4444 !important;
        }

        .highlight-orange {
            color: #f97316 !important;
        }

        .highlight-green {
            color: #22c55e !important;
        }

        .details-desc {
            background-color: #f8fafc;
            padding: 16px;
            border-radius: 6px;
            font-size: 0.95rem;
            color: #475569;
            line-height: 1.6;
        }

        .details-media {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .details-photo {
            flex: 0 0 250px;
            height: 180px;
            background-color: #f1f5f9;
            border-radius: 6px;
            object-fit: cover;
            border: 1px solid #e2e8f0;
        }

        .details-content {
            flex: 1;
        }

        .btn-link {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            background-color: #1e293b;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            margin-top: 15px;
            transition: background-color 0.2s;
        }

        .btn-link:hover {
            background-color: #334155;
        }

        /* Utilities */
        .hidden {
            display: none;
        }

        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .loading {
            color: #64748b;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }

        /* Mobile Adjustments */
        @media (max-width: 600px) {
            body {
                padding: 15px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.8rem;
            }

            #map {
                height: 300px;
            }

            .details-card {
                padding: 16px;
            }

            .details-media {
                flex-direction: column;
            }

            .details-photo {
                flex: 0 0 auto;
                width: 100%;
            }
        }
    </style>
</head>

<body>

    <header>
        <div class="brand">
            <img src="art.svg" alt="Tool Icon" class="tool-icon">
            <h1>Hawker Cleaning Schedule</h1>
        </div>
        <p class="subtitle">View upcoming cleaning schedules for Hawker Centres in Singapore. Data provided by <a
                href="https://data.gov.sg/datasets/d_bda4baa634dd1cc7a6c7cad5f19e2d68/view">data.gov.sg</a>.</p>
    </header>

    <main class="container">
        <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 15px;">
            <span id="record-count" style="color: #64748b; font-size: 0.9rem;"></span>
        </div>

        <!-- Error Message Container -->
        <div id="error-msg" class="error hidden"></div>

        <!-- Content Area -->
        <div id="loading-indicator" class="loading hidden">Loading data...</div>

        <div id="map"></div>

        <!-- Details Section -->
        <section id="details-section" class="details-card">
            <div id="details-placeholder" class="loading">Click a hawker centre on the map to see more details.</div>

            <div id="details-content-wrapper" class="hidden">
                <div class="details-header">
                    <h2 id="d-name" class="details-title">Centre Name</h2>
                    <div id="d-address" class="details-subtitle">Address</div>
                </div>

                <div class="details-media">
                    <img id="d-photo" src="" alt="Hawker Centre Photo" class="details-photo">
                    <div class="details-content">
                        <div class="details-grid">
                            <div class="detail-item">
                                <label>Next Cleaning</label>
                                <span id="d-cleaning-date">Loading...</span>
                            </div>
                            <div class="detail-item">
                                <label>Days Until</label>
                                <span id="d-days-left">Loading...</span>
                            </div>
                            <div class="detail-item">
                                <label>Food Stalls</label>
                                <span id="d-food-stalls">-</span>
                            </div>
                            <div class="detail-item">
                                <label>Market Stalls</label>
                                <span id="d-market-stalls">-</span>
                            </div>
                        </div>

                        <a id="d-google-3d" href="#" target="_blank" class="btn-link hidden">View Google 3D View</a>
                    </div>
                </div>

                <div class="detail-item">
                    <label>Description</label>
                    <div id="d-desc" class="details-desc"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- Configuration ---
        const datasetId = "d_bda4baa634dd1cc7a6c7cad5f19e2d68";
        // data.gov.sg limit default is often 100, we might want more. 
        // Adding limit=500 to catch more records if available.
        const url = `https://data.gov.sg/api/action/datastore_search?resource_id=${datasetId}&limit=1000`;

        // --- Elements ---
        const errorMsg = document.getElementById('error-msg');
        const loadingIndicator = document.getElementById('loading-indicator');
        const recordCount = document.getElementById('record-count');
        const detailsSection = document.getElementById('details-section');
        const detailsPlaceholder = document.getElementById('details-placeholder');
        const detailsContentWrapper = document.getElementById('details-content-wrapper');

        // --- State ---
        let map;
        let markers = [];

        // --- Logic ---

        async function fetchData() {
            // Reset UI
            hideError();
            loadingIndicator.classList.remove('hidden');
            recordCount.textContent = '';

            // Reset Details to placeholder
            detailsPlaceholder.classList.remove('hidden');
            detailsContentWrapper.classList.add('hidden');

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch data (Status: ${response.status})`);
                }
                const data = await response.json();

                if (data.success && data.result && data.result.records) {
                    recordCount.textContent = `${data.result.records.length} records found`;
                    renderMap(data.result.records);
                } else {
                    throw new Error('Invalid data format received.');
                }

            } catch (error) {
                console.error('Error fetching data:', error);
                showError(`Error: ${error.message}. Please try again later.`);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function initMap() {
            if (map) return; // Already initialized

            // Singapore Coordinates: 1.3521° N, 103.8198° E
            map = L.map('map').setView([1.3521, 103.8198], 11);

            // Minimalist Tile Layer (CartoDB Positron)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            // Legend
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML += '<i style="background: #ef4444"></i> Cleaning within 7 days<br>';
                div.innerHTML += '<i style="background: #f97316"></i> Cleaning within 30 days<br>';
                div.innerHTML += '<i style="background: #22c55e"></i> Cleaning > 30 days<br>';
                div.innerHTML += '<i style="background: #94a3b8"></i> TBC / No Data<br>';
                return div;
            };
            legend.addTo(map);
        }

        // Helper: Parse DD/MM/YYYY
        function parseDate(dateStr) {
            if (!dateStr || dateStr === 'TBC' || dateStr === 'NA') return null;
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            // Note: Month is 0-indexed in JS Date
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }

        // Helper: Get next cleaning info
        function getNextCleaning(record) {
            const now = new Date();
            // Reset time to start of day for accurate day comparison
            now.setHours(0, 0, 0, 0);

            let dates = [];
            // Check all 4 quarters
            ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                const startStr = record[`${q}_cleaningstartdate`];
                const date = parseDate(startStr);
                if (date) {
                    dates.push({date: date, raw: startStr, q: q});
                }
            });

            // Filter only future dates or today
            const futureDates = dates.filter(d => d.date >= now);

            // Sort by date ascending
            futureDates.sort((a, b) => a.date - b.date);

            if (futureDates.length === 0) return null;

            const next = futureDates[0];
            const diffTime = Math.abs(next.date - now);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            return {
                dateObj: next.date,
                dateStr: next.raw,
                daysLeft: diffDays
            };
        }

        function getColor(daysLeft) {
            if (daysLeft === null || daysLeft === undefined) return "#94a3b8"; // Slate-400 (Grey)
            if (daysLeft <= 7) return "#ef4444"; // Red-500
            if (daysLeft <= 30) return "#f97316"; // Orange-500
            return "#22c55e"; // Green-500
        }

        function renderMap(records) {
            initMap();

            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            const bounds = L.latLngBounds();

            records.forEach(record => {
                const lat = parseFloat(record.latitude_hc);
                const lon = parseFloat(record.longitude_hc);
                const name = record.name;

                if (!isNaN(lat) && !isNaN(lon)) {
                    // Calculate visual state
                    const nextClean = getNextCleaning(record);
                    const daysLeft = nextClean ? nextClean.daysLeft : null;
                    const color = getColor(daysLeft);

                    // Marker Config
                    const marker = L.circleMarker([lat, lon], {
                        radius: 8,
                        fillColor: color,
                        color: "#fff",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    // Add tooltip for hover
                    marker.bindTooltip(name, {
                        direction: 'top',
                        offset: [0, -10],
                        className: 'custom-tooltip' // Optional: for custom styling if needed
                    });

                    // Add click listener
                    marker.on('click', () => {
                        showDetails(record, nextClean);
                    });

                    markers.push(marker);
                    bounds.extend([lat, lon]);
                }
            });

            // Fit map to bounds if we have markers
            if (markers.length > 0) {
                map.fitBounds(bounds, {padding: [50, 50]});
            }
        }

        function showDetails(record, nextClean) {
            // Populate Fields
            document.getElementById('d-name').textContent = record.name;
            document.getElementById('d-address').textContent = record.address_myenv || 'Address not available';
            document.getElementById('d-food-stalls').textContent = record.no_of_food_stalls || '0';
            document.getElementById('d-market-stalls').textContent = record.no_of_market_stalls || '0';
            document.getElementById('d-desc').textContent = record.description_myenv || 'No description available.';

            // Photo
            const photoImg = document.getElementById('d-photo');
            if (record.photourl && record.photourl !== 'nil') {
                photoImg.src = record.photourl;
                photoImg.classList.remove('hidden');
            } else {
                photoImg.classList.add('hidden');
            }

            // Google 3D
            const googleLink = document.getElementById('d-google-3d');
            if (record.google_3d_view && record.google_3d_view !== 'nil') {
                googleLink.href = record.google_3d_view;
                googleLink.classList.remove('hidden');
            } else {
                googleLink.classList.add('hidden');
            }

            const dateEl = document.getElementById('d-cleaning-date');
            const daysEl = document.getElementById('d-days-left');

            // Reset classes
            daysEl.className = '';

            if (nextClean) {
                dateEl.textContent = nextClean.dateStr;

                const days = nextClean.daysLeft;
                if (days === 0) {
                    daysEl.textContent = 'Today';
                    daysEl.classList.add('highlight-red');
                } else {
                    daysEl.textContent = `${days} day${days !== 1 ? 's' : ''}`;

                    // Color coding
                    if (days <= 7) daysEl.classList.add('highlight-red');
                    else if (days <= 30) daysEl.classList.add('highlight-orange');
                    else daysEl.classList.add('highlight-green');
                }
            } else {
                dateEl.textContent = 'TBC / No Data';
                daysEl.textContent = '-';
            }

            // Show content, hide placeholder
            detailsPlaceholder.classList.add('hidden');
            detailsContentWrapper.classList.remove('hidden');

            // Smooth scroll to details
            detailsSection.scrollIntoView({behavior: 'smooth', block: 'start'});
        }

        // --- Helpers ---

        function formatHeader(str) {
            // Replace underscores with spaces and title case
            return str.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }

        function showError(msg) {
            errorMsg.textContent = msg;
            errorMsg.classList.remove('hidden');
        }

        function hideError() {
            errorMsg.classList.add('hidden');
        }

        // --- Event Listeners ---

        // Auto-load on start
        fetchData();

    </script>
</body>

</html>
